import { db } from './firebase-config.js';
// Importamos o Auth do Firebase para o login
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const auth = getAuth();
const loginForm = document.getElementById('loginForm');
const btnEntrar = document.getElementById('btnEntrar');

if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('email').value;
        const senha = document.getElementById('senha').value;

        // Visual de carregamento
        btnEntrar.disabled = true;
        btnEntrar.innerText = "AUTENTICANDO...";

        try {
            // 1. Tenta fazer o login no Firebase Auth
            const userCredential = await signInWithEmailAndPassword(auth, email, senha);
            const user = userCredential.user;

            // 2. Busca os dados do usuário no Firestore para pegar a cor do tema
            const userDoc = await getDoc(doc(db, "usuarios", user.uid));
            
            if (userDoc.exists()) {
                const dados = userDoc.data();
                // Salva a cor no localStorage para o login brilhar na cor certa na próxima vez
                if (dados.corTema) {
                    localStorage.setItem('tema-cor', dados.corTema);
                }
                
                // 3. Redireciona para o painel administrativo
                // Altere 'painel.html' para o nome do seu arquivo de administração
                window.location.href = `painel.html?id=${user.uid}`;
            } else {
                alert("Perfil não encontrado no banco de dados.");
            }

        } catch (error) {
            console.error("Erro ao entrar:", error);
            btnEntrar.disabled = false;
            btnEntrar.innerText = "ENTRAR NO SISTEMA";

            // Tratamento de erros amigável
            switch (error.code) {
                case 'auth/invalid-credential':
                    alert("E-mail ou senha incorretos.");
                    break;
                case 'auth/user-not-found':
                    alert("Usuário não cadastrado.");
                    break;
                case 'auth/wrong-password':
                    alert("Senha incorreta.");
                    break;
                default:
                    alert("Erro ao acessar o sistema. Verifique sua conexão.");
            }
        }
    });
}
