import { db } from './firebase-config.js';
import {
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc,
    setDoc,
    addDoc,
    serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const params = new URLSearchParams(window.location.search);
const userId = params.get('id');
let whatsappLoja = "";
let lojaAberta = true;
let configHorario = { abertura: "", fechamento: "" };
let configEntrega = null;

let carrinho = [];
let taxaEntregaAtual = 0;
let distanciaCliente = 0;
let modoPedido = 'entrega';
let formaPagamento = 'Dinheiro'; // Valor default
let enderecoCompleto = { rua: "", bairro: "", cidade: "", cep: "" };
let clienteLogado = null;

// --- FUN√á√ïES DE AUX√çLIO ---
function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

window.definirModo = (modo) => {
    modoPedido = modo;
    document.getElementById('optEntrega').classList.toggle('border-brand', modo === 'entrega');
    document.getElementById('optRetirada').classList.toggle('border-brand', modo === 'retirada');
    recalcularTaxaEntrega();
};

function recalcularTaxaEntrega() {
    if (modoPedido === 'retirada') {
        taxaEntregaAtual = 0;
    } else if (configEntrega && configEntrega.tipo === 'km') {
        taxaEntregaAtual = parseFloat((distanciaCliente * configEntrega.valorKm).toFixed(2));
    } else if (configEntrega) {
        taxaEntregaAtual = Number(configEntrega.taxaFixa) || 0;
    }
    renderizarCarrinho();
}

// --- RENDERIZA√á√ÉO DO LAYOUT ---
window.adicionarAoCarrinho = (nome, preco) => {
    if (!lojaAberta) {
        alert("Loja Fechada no momento!");
        return;
    }
    carrinho.push({ nome, preco: Number(preco) });
    atualizarBadgeCarrinho();
    renderizarCarrinho();
};

function atualizarBadgeCarrinho() {
    const btn = document.getElementById('btnCarrinho');
    const badgeQtd = document.getElementById('qtdItensCarrinho');
    if (carrinho.length > 0) {
        btn.classList.remove('hidden');
        if (badgeQtd) badgeQtd.innerText = carrinho.length;
    } else {
        btn.classList.add('hidden');
    }
}

function renderizarCarrinho() {
    const container = document.getElementById('listaItensCarrinho');
    const totalP1 = document.getElementById('totalPasso1');
    const badgeTotal = document.getElementById('valorTotalBadge');

    if (!container) return;
    container.innerHTML = "";
    let subtotal = 0;

    carrinho.forEach((item, index) => {
        subtotal += item.preco;
        container.innerHTML += `
            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl mb-1">
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-slate-700 uppercase">${item.nome}</span>
                    <span class="text-xs text-brand font-black">R$ ${item.preco.toFixed(2)}</span>
                </div>
                <button onclick="window.removerDoCarrinho(${index})" class="text-[10px] font-black text-red-500 bg-red-50 px-3 py-1 rounded-lg uppercase">Remover</button>
            </div>`;
    });

    const totalGeral = subtotal + taxaEntregaAtual;
    if (badgeTotal) badgeTotal.innerText = `R$ ${totalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

    if (totalP1) {
        totalP1.innerHTML = `
            <div class="flex justify-between items-center p-4 bg-slate-900 rounded-2xl text-white mt-4">
                <span class="text-[10px] font-bold uppercase opacity-60 italic">Total Geral</span>
                <span class="font-black text-lg">R$ ${totalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
            </div>`;
    }
}

window.removerDoCarrinho = (index) => {
    carrinho.splice(index, 1);
    atualizarBadgeCarrinho();
    renderizarCarrinho();
};

window.abrirCarrinho = () => {
    document.getElementById('modalCarrinho').classList.remove('hidden');
    renderizarCarrinho();
};

window.fecharCarrinho = () => {
    document.getElementById('modalCarrinho').classList.add('hidden');
};

// --- L√ìGICA WHATSAPP ---
window.enviarWhatsApp = async () => {
    const nomeCliente = document.getElementById('inputNome')?.value || "Cliente Online";
    const subtotal = carrinho.reduce((a, b) => a + b.preco, 0);
    const totalFinal = subtotal + taxaEntregaAtual;

    let numDestino = whatsappLoja.replace(/\D/g, '');
    if (numDestino.length >= 10 && numDestino.length <= 11) numDestino = '55' + numDestino;

    let msg = `*NOVO PEDIDO* üçî\n`;
    msg += `*Cliente:* ${nomeCliente}\n`;
    msg += `------------------------------\n`;
    carrinho.forEach(i => msg += `‚Ä¢ ${i.nome} - R$ ${i.preco.toFixed(2)}\n`);
    msg += `------------------------------\n`;
    msg += `*Modo:* ${modoPedido === 'entrega' ? 'üõµ Entrega' : 'üõçÔ∏è Retirada'}\n`;
    msg += `*TOTAL: R$ ${totalFinal.toFixed(2)}*\n`;

    const linkWhats = `https://wa.me/${numDestino}?text=${encodeURIComponent(msg)}`;
    window.location.assign(linkWhats);
};

// --- INICIALIZA√á√ÉO ---
function verificarSeEstaAberto(abertura, fechamento) {
    if (!abertura || !fechamento) return true;
    const agora = new Date();
    const horaAtual = agora.getHours() * 60 + agora.getMinutes();
    const [hAbre, mAbre] = abertura.split(':').map(Number);
    const [hFecha, mFecha] = fechamento.split(':').map(Number);
    const minAbre = hAbre * 60 + mAbre;
    const minFecha = hFecha * 60 + mFecha;
    if (minFecha < minAbre) return horaAtual >= minAbre || horaAtual <= minFecha;
    return horaAtual >= minAbre && horaAtual <= minFecha;
}

async function inicializar() {
    if (!userId) return;
    try {
        const userSnap = await getDoc(doc(db, "usuarios", userId));
        if (userSnap.exists()) {
            const d = userSnap.data();
            whatsappLoja = d.whatsapp || "";
            if (d.corTema) document.documentElement.style.setProperty('--cor-primaria', d.corTema);
            
            document.getElementById('nomeLoja').innerText = d.nomeNegocio || "Loja";
            if (d.fotoCapa) document.getElementById('bannerLoja').style.backgroundImage = `url('${d.fotoCapa}')`;
            
            const imgPerfil = document.getElementById('logoLoja');
            if ((d.fotoPerfil || d.fotoLogo) && imgPerfil) {
                imgPerfil.src = d.fotoPerfil || d.fotoLogo;
                imgPerfil.classList.remove('hidden');
                document.getElementById('emojiLoja').classList.add('hidden');
            }

            lojaAberta = verificarSeEstaAberto(d.horarioAbertura, d.horarioFechamento);
            const dot = document.getElementById('dotStatus');
            const label = document.getElementById('labelStatus');
            if (lojaAberta) {
                dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]";
                label.innerHTML = `<span class="text-green-600">Aberto</span> ‚Ä¢ Fecha √†s ${d.horarioFechamento}`;
            } else {
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                label.innerHTML = `<span class="text-red-600">Fechado no momento</span>`;
            }
        }

        const q = query(collection(db, "produtos"), where("userId", "==", userId));
        const snap = await getDocs(q);
        const prods = {};
        snap.forEach(doc => {
            const p = doc.data();
            if (!prods[p.categoria]) prods[p.categoria] = [];
            prods[p.categoria].push(p);
        });

        const nav = document.getElementById('navCategorias');
        const main = document.getElementById('mainContainer');

        Object.keys(prods).forEach(cat => {
            // Nav Pills
            const link = document.createElement('a');
            link.href = `#${cat.replace(/\s/g, '')}`;
            link.className = "category-pill";
            link.innerText = cat;
            nav.appendChild(link);

            // Section
            let section = `<section id="${cat.replace(/\s/g, '')}" class="mb-8">
                <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 ml-2">${cat}</h2>
                <div class="grid grid-cols-1 gap-1">`;
            
            prods[cat].forEach(p => {
                section += `
                    <div class="product-card" onclick="window.adicionarAoCarrinho('${p.nome}', ${p.preco})">
                        <div class="product-info">
                            <h3 class="product-name">${p.nome}</h3>
                            <p class="product-desc">${p.descricao || ''}</p>
                            <p class="product-price text-brand">R$ ${Number(p.preco).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                        </div>
                        <div class="product-img-container">
                            <img src="${p.foto}" class="product-img">
                            <div class="add-btn-small bg-brand">+</div>
                        </div>
                    </div>`;
            });
            main.innerHTML += section + `</div></section>`;
        });

        document.getElementById('loading-overlay').classList.add('loader-hidden');
    } catch (e) { console.error(e); }
}

inicializar();
